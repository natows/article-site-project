<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article Details</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <h1 id="articleTitle"></h1>
    </header>
    <main>
        <div>
            <p id="articleAuthor"></p>
            <p id="articleContent"></p>
            <p class="date" id="articleDate"></p>
        </div>
        <div id="commentSection">
            <h2>Comments</h2>
            <div id="comments"></div>
            <div id="commentInputSection">
                <input id="commentInput" placeholder="Type a comment"/>
                <button onclick="sendComment()">Send</button>
            </div>
            <p id="loginPrompt" class="hidden"><a href="/login">Log in to write comments</a></p>
        </div>
    </main>

    <script>
        const socket = io();
        let username = '';
        let isAdmin = false;
        const articleId = window.location.pathname.split('/').pop(); 
        fetch(`/api/articles/${articleId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('articleTitle').textContent = data.title;
                document.getElementById('articleAuthor').textContent = `Author: ${data.author}`;
                document.getElementById('articleContent').textContent = data.content;
                document.getElementById('articleDate').textContent = `Published on: ${new Date(data.date_created).toLocaleDateString()}`;
                loadComments(); 
            })
            .catch(error => console.error('Error fetching article:', error));

        const room = `article_${articleId}`;

        socket.on('connect', function() {
            if (!username) {
                console.error('Username is not set');
                return;
            }
            console.log('Connected to WebSocket');
            socket.emit('join', { username, room });
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from WebSocket');
        });

        socket.on('comment', function(data) {
            const commentsDiv = document.getElementById('comments');
            const commentElement = document.createElement('div');
            commentElement.classList.add('message');
            commentElement.id = `comment-${data.id}`;
            
            if (data.username === username) {
                commentElement.classList.add('self');
            }

            commentElement.innerHTML = `<span class="username">${data.username}:</span><span class="text">${data.text}</span>`;

            if (isAdmin || data.username === username) {
                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-btn');
                deleteButton.innerHTML = '<i class="fa fa-trash"></i>';
                deleteButton.onclick = function() {
                    deleteComment(data.id);  
                };
                commentElement.appendChild(deleteButton);

                const editButton = document.createElement('button');
                editButton.classList.add('edit-btn');
                editButton.innerHTML = '<i class="fa fa-pen"></i>';
                editButton.onclick = function() {
                    editComment(data.id, data.text);
                };
                commentElement.appendChild(editButton);
            }

            commentsDiv.appendChild(commentElement);
        });

        socket.on('delete_comment', function(data) {
            const commentElement = document.getElementById(`comment-${data.id}`);
            if (commentElement) {
                commentElement.remove();
            }
        });

        socket.on('edit_comment', function(data) {
            const commentElement = document.getElementById(`comment-${data.id}`);
            if (commentElement) {
                const textElement = commentElement.querySelector('.text');
                textElement.textContent = data.text;
            }
        });

        function sendComment() {
            const text = document.getElementById('commentInput').value;
            if (!username) {
                console.error('Username is not set');
                return;
            }

            fetch('/api/comments', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ article_id: articleId, username, text })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    socket.emit('comment', { id: data.id, username, text, room });
                    document.getElementById('commentInput').value = '';
                } else {
                    console.error(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function loadComments() {
            fetch(`/api/comments/${articleId}`, {
                method: 'GET',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                const commentsDiv = document.getElementById('comments');
                commentsDiv.innerHTML = '';
                data.forEach(comment => {
                    const commentElement = document.createElement('div');
                    commentElement.classList.add('message');
                    commentElement.id = `comment-${comment.id}`;
                    commentElement.innerHTML = `<span class="username">${comment.username}:</span><span class="text">${comment.text}</span>`;
                    if (isAdmin || comment.username === username) {
                        const deleteButton = document.createElement('button');
                        deleteButton.classList.add('delete-btn');
                        deleteButton.innerHTML = '<i class="fa fa-trash"></i>';
                        deleteButton.onclick = function() {
                            deleteComment(comment.id);
                        };
                        commentElement.appendChild(deleteButton);

                        const editButton = document.createElement('button');
                        editButton.classList.add('edit-btn');
                        editButton.innerHTML = '<i class="fa fa-pen"></i>';
                        editButton.onclick = function() {
                            editComment(comment.id, comment.text);
                        };
                        commentElement.appendChild(editButton);
                    }
                    commentsDiv.appendChild(commentElement);
                });
            })
            .catch(error => console.error('Error fetching comments:', error));
        }

        function deleteComment(commentId) {
            fetch(`/api/comments/${commentId}`, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    socket.emit('delete_comment', { id: commentId, room });
                    const commentElement = document.getElementById(`comment-${commentId}`);
                    if (commentElement) {
                        commentElement.remove();
                    }
                } else {
                    console.error(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function editComment(commentId, oldText) {
            const newText = prompt('Edit your comment:', oldText);
            if (newText && newText !== oldText) {
                fetch(`/api/comments/${commentId}`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: newText })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        socket.emit('edit_comment', { id: commentId, text: newText, room });
                    } else {
                        console.error(data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            fetch('/api/user', {
                method: 'GET',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.username) {
                    username = data.username;
                    isAdmin = data.is_admin;
                    console.log('Username set to:', username);
                    socket.emit('join', { username, room });
                
                    document.getElementById('commentInputSection').classList.remove('hidden');
                    document.getElementById('loginPrompt').classList.add('hidden');
                } else {
                    document.getElementById('commentInputSection').classList.add('hidden');
                    document.getElementById('loginPrompt').classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('commentInputSection').classList.add('hidden');
                document.getElementById('loginPrompt').classList.remove('hidden');
            });
        });

    </script>
</body>
</html>
