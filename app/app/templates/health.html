<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Section</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        .hidden {
            display: none;
        }
        #chat {
            border: 2px solid #ccc;
            padding: 10px;
            width: 200px;
            height: 150px;
            overflow-y: auto;
            box-sizing: border-box;
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
        }

        .message {
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 5px;
            max-width: 80%; 
            word-wrap: break-word;
        }

        .self {
            align-self: flex-end; 
            background: #d1e7fd;
            padding: 8px;
        }

        .others {
            align-self: flex-start; 
            background: #e1e1e1;
            padding: 8px;
        }

    </style>
</head>
<body>
    <header>
        <h1>Health Section</h1>
    </header>
    <main>
        <div>
            <div>
                <input id="searchInput" placeholder="Search articles"/>
                <button onclick="searchArticles()">Search</button>
                <button id="subscribeButton" onclick="toggleSubscription('health')" class="hidden"></button>
            </div>
            <button id="openChat" onclick="openChat()">Open chat</button>
            <div id="chatSection" class="hidden">
                <h2>Live Chat</h2>
                <div id="chat"></div>
                <input id="chatInput" placeholder="Type a message"/>
                <button onclick="sendMessage()">Send</button>
            </div>
            <button class="hidden" id="closeChat" onclick="openChat()">Close chat</button>
        </div>
        <div id="articles"></div>
    </main>

    <script>
        const client = new Paho.MQTT.Client('broker.hivemq.com', 8000, 'clientId-' + Math.random().toString(16).substr(2, 8));
        const chatTopic = 'projektProtokoly/chat/health';
        const notificationTopic = 'projektProtokoly/notifications/health';
        let username = 'Anonymous User';
        let user = null;
        const channel = 'health';

        function scrollToBottom() {
            const chatDiv = document.getElementById('chat');
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        client.onMessageArrived = function(message) {
            const chatDiv = document.getElementById('chat');
            const msg = JSON.parse(message.payloadString);
            const msgElement = document.createElement('div');
            msgElement.classList.add('message');

            if (msg.username === username) {
                msgElement.classList.add('self');
            } else {
                msgElement.classList.add('others');
            }

            msgElement.innerHTML = `<span class="username">${msg.username}:</span> <span class="text">${msg.text}</span>`;
            chatDiv.appendChild(msgElement);
            scrollToBottom();
        };


        client.connect({ onSuccess: function() {
            console.log('Connected to MQTT broker');
            client.subscribe(chatTopic);
        }});

        function sendMessage() {
            const text = document.getElementById('chatInput').value;
            const message = JSON.stringify({ username, text });
            const mqttMessage = new Paho.MQTT.Message(message);
            mqttMessage.destinationName = chatTopic;
            client.send(mqttMessage);
            document.getElementById('chatInput').value = '';
        }

        document.addEventListener('DOMContentLoaded', function() {
            fetch('/api/user', {
                method: 'GET',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.username) {
                    user = data;
                    username = data.username;
                    console.log('Username set to:', username);
                    document.getElementById('copenChat').classList.remove('hidden');
                    document.getElementById('subscribeButton').classList.remove('hidden');
                    updateSubscriptionButton('health');
                }
                else {
                    document.getElementById('openChat').classList.add('hidden');
                }
            })
            .catch(error => console.error('Error:', error));
            fetchArticles();
        });

        function openChat(){
            document.getElementById('chatSection').classList.toggle('hidden');
            document.getElementById('openChat').classList.toggle('hidden');
            document.getElementById('closeChat').classList.toggle('hidden');
        }


        function fetchArticles(query = '') {
            fetch(`/api/articles/health?query=${query}`)
                .then(response => response.json())
                .then(data => {
                    const articlesDiv = document.getElementById('articles');
                    articlesDiv.innerHTML = '';
                    data.forEach(article => {
                        const articleElement = document.createElement('article');
                        const truncatedContent = article.content.length > 70 ? article.content.substring(0, 70) + '...' : article.content;
                        articleElement.innerHTML = `<h2><a href="/article/${article.id}">${article.title}</a></h2><p>${truncatedContent}</p><p class="date">Published on: ${new Date(article.date_created).toLocaleDateString()}</p><p>Author: ${article.author}</p>`;
                        articlesDiv.appendChild(articleElement);
                    });
                })
                .catch(error => console.error('Error:', error));
        }

        function searchArticles() {
            const query = document.getElementById('searchInput').value;
            fetchArticles(query);
        }

        async function toggleSubscription(channel) {
            try {
                const response = await fetch('/api/subscriptions', {
                    method: 'GET',
                    credentials: 'include'
                });

                const data = await response.json();
                let subscriptions = data.subscriptions || [];
                const subscriptionButton = document.getElementById('subscribeButton');

                if (!subscriptions.includes(channel)) {
                    const subResponse = await fetch('/api/subscribe', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ channel })
                    });

                    const subData = await subResponse.json();
                    console.log(subData.message);
                    client.subscribe(notificationTopic);
                    subscriptions.push(channel);
                    subscriptionButton.innerText = 'Unsubscribe from Health';
                } else {
                    const unsubResponse = await fetch('/api/unsubscribe', {
                        method: 'DELETE',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ channel })
                    });

                    const unsubData = await unsubResponse.json();
                    console.log(unsubData.message);
                    client.unsubscribe(notificationTopic);
                    subscriptions = subscriptions.filter(sub => sub !== channel);
                    subscriptionButton.innerText = 'Subscribe to Health';
                }

                user.subscriptions = subscriptions;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function updateSubscriptionButton(channel) {
            const subscriptionButton = document.getElementById('subscribeButton');
            if (user && user.subscriptions.includes(channel)) {
                subscriptionButton.innerText = `Unsubscribe from ${channel}`;
            } else {
                subscriptionButton.innerText = `Subscribe to ${channel}`;
            }
        }
    </script>
</body>
</html>